{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h1 class="h3 mb-0">{{ title }}</h1>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.code.label(class="form-label") }}
                                    {{ form.code(class="form-control") }}
                                    {% if form.code.errors %}
                                        <div class="text-danger">
                                            {% for error in form.code.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-group">
                                    {{ form.name.label(class="form-label") }}
                                    {{ form.name(class="form-control") }}
                                    {% if form.name.errors %}
                                        <div class="text-danger">
                                            {% for error in form.name.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows=3) }}
                            {% if form.description.errors %}
                                <div class="text-danger">
                                    {% for error in form.description.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.grade_level.label(class="form-label") }}
                                    {{ form.grade_level(class="form-control") }}
                                    {% if form.grade_level.errors %}
                                        <div class="text-danger">
                                            {% for error in form.grade_level.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.credits.label(class="form-label") }}
                                    {{ form.credits(class="form-control") }}
                                    {% if form.credits.errors %}
                                        <div class="text-danger">
                                            {% for error in form.credits.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.teachers.label(class="form-label") }}
                            {{ form.teachers(class="form-select", multiple=true, size=5) }}
                            {% if form.teachers.errors %}
                                <div class="text-danger">
                                    {% for error in form.teachers.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple teachers</small>
                        </div>
                        
                        {% if form.students is defined %}
                        <div class="form-group mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Enroll Students</label>
                                <div class="input-group" style="max-width: 300px;">
                                    <input type="text" id="studentSearch" class="form-control form-control-sm" placeholder="Search students...">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clearSearch">Clear</button>
                                </div>
                            </div>
                            {{ form.students(class="form-select", multiple=true, size=10, id="studentSelect") }}
                            {% if form.students.errors %}
                                <div class="text-danger">
                                    {% for error in form.students.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple students</small>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="selectAll">Select All</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAll">Deselect All</button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if form.students is defined %}
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const studentSearch = document.getElementById('studentSearch');
                                const studentSelect = document.getElementById('studentSelect');
                                const clearSearch = document.getElementById('clearSearch');
                                const selectAll = document.getElementById('selectAll');
                                const deselectAll = document.getElementById('deselectAll');
                                
                                if (studentSelect && studentSearch && clearSearch && selectAll && deselectAll) {
                                    // Search functionality
                                    studentSearch.addEventListener('input', function() {
                                        const searchValue = this.value.toLowerCase();
                                        const options = studentSelect.options;
                                        
                                        for (let i = 0; i < options.length; i++) {
                                            const optionText = options[i].text.toLowerCase();
                                            if (optionText.includes(searchValue)) {
                                                options[i].style.display = '';
                                            } else {
                                                options[i].style.display = 'none';
                                            }
                                        }
                                    });
                                    
                                    // Clear search
                                    clearSearch.addEventListener('click', function() {
                                        studentSearch.value = '';
                                        const options = studentSelect.options;
                                        for (let i = 0; i < options.length; i++) {
                                            options[i].style.display = '';
                                        }
                                    });
                                    
                                    // Select all visible students
                                    selectAll.addEventListener('click', function() {
                                        const options = studentSelect.options;
                                        for (let i = 0; i < options.length; i++) {
                                            if (options[i].style.display !== 'none') {
                                                options[i].selected = true;
                                            }
                                        }
                                    });
                                    
                                    // Deselect all students
                                    deselectAll.addEventListener('click', function() {
                                        const options = studentSelect.options;
                                        for (let i = 0; i < options.length; i++) {
                                            options[i].selected = false;
                                        }
                                    });
                                }
                            });
                        </script>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between">
                            <a href="/admin/subjects" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}